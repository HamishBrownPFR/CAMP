---
title: "Inspection of qPCR Sample Date 1 Pilot"
author: "John McCallum, Meeghan Pither-Joyce, Hamish Brown"
date: "MOnday , May 7, 2018"
output:
  word_document: default
  html_document: default
---

Inspection of qPCR Sample Date 3 and Merge with Date 1
========================================================

#### May  2018



--------------
```{r global_options, include=FALSE}
library(knitr)
rm(list=ls())
opts_chunk$set(fig.width=12, fig.height=8, fig.path='Figs/',
               echo=TRUE, warning=FALSE, message=FALSE)
```

#### Set file location accordingly and get sheetnames
```{r message=FALSE, warning=FALSE}
# library(gdata)
library(data.table)
library(dplyr)
library(tidyr)
library(ggplot2)
require(gdata)
require(car)
```

### Read in collated data and trim whitespace

```{r}
raw_dt <- fread('Sampledate3_raw.csv',stringsAsFactors = TRUE)
raw_dt$SampleName <- trim(raw_dt$SampleName)
raw_dt$plate <- as.numeric(gsub("plate","",raw_dt$plate))
```

### Now plot to inspect Ct
```{r}
raw_dt %>% ggplot(aes(x=Ct,fill=TargetName)) + 
  geom_histogram(position='stack') + 
  ggtitle('Ct raw data-Sample Date 3')

```

### Inspect Ct distribution in Samples

#### Read in Sampling Times

```{r}
sample_times_df <- fread('./Sampling Times.txt')
head(sample_times_df)
```



## Inspect Without Cutoff for gene

```{r}

raw_dt %>% filter(Task == 'Unknown'  ) %>%
  separate(SampleName,into=c('geno','num'),sep = " ") %>%
  ggplot(data=.,aes(x=Ct)) +
  geom_density(aes(color=TargetName),alpha=0.3) +
  ggtitle('Wheat GXE qPCR: Sample Date 3')

```

### Inspect correlation of Housekeepers

```{r}
raw_dt %>% filter(Task == 'Unknown' & (TargetName == "EGF1a" | TargetName == "Ta54227")) %>% unique %>% group_by(TargetName,SampleName) %>% 
  summarise(meanCt=mean(Ct))  %>%
    spread(TargetName,meanCt) %>%
    ggplot(aes(x=EGF1a,y=Ta54227)) + 
  geom_point() +
  ggtitle('Wheat GXE qPCR: Sample Date 3 Housekeepers')
```

## Plot dodgey samples
```{r}
raw_dt %>% filter(TargetName=='Ta54227', Ct > 32.5)
```


### Spread out by gene 

```{r}
raw_dt %>% 
  filter(Task == 'Unknown') %>%
  group_by(TargetName,SampleName) %>%
  summarise(meanCt=mean(Ct))  %>%
  spread(TargetName,meanCt) 
```

### Spread out by sample , calculate means by sample and join to sample time

```{r}
raw_dt %>% filter(Task == 'Unknown' & SampleName != 'extra') %>%
  spread(TargetName,Ct) %>% 
  group_by(plate,SampleName) %>% 
  summarise(EGF1a_mean=mean(EGF1a,na.rm=T),
            Ta54227_mean=mean(Ta54227,na.rm=T),
            VRN1_mean=mean(VRN1,na.rm=T),
            VRN2_mean=mean(VRN2,na.rm=T),
            VRN3_mean=mean(VRN3,na.rm=T)) %>%
inner_join(sample_times_df,copy = TRUE) %>%
  arrange(Time,SampleName)
```




### Clean up fields further and save to a data table
```{r}
sample_dt <- data.table(raw_dt %>% filter(Task == 'Unknown' & SampleName != 'extra') %>%
  spread(TargetName,Ct) %>% 
  group_by(plate,SampleName) %>% 
  summarise(EGF1a_mean=mean(EGF1a,na.rm=T),
            Ta54227_mean=mean(Ta54227,na.rm=T),
            VRN1_mean=mean(VRN1,na.rm=T),
            VRN2_mean=mean(VRN2,na.rm=T),
            VRN3_mean=mean(VRN3,na.rm=T)) %>%
inner_join(sample_times_df,copy = TRUE)%>%
  separate(SampleName, into=c('Genotype','Pot')) %>%
    mutate(Time=as.numeric(gsub("S","",Time))) %>%
  arrange(Time,Genotype))
head(sample_dt)
```




## Calculate Delta Cts

```{r}
(sample_Ct_dt <- data.table(sample_dt %>%

    mutate(EdeltaCT_VRN1=2^-(VRN1_mean - EGF1a_mean),
                     EdeltaCT_VRN2=2^-(VRN2_mean - EGF1a_mean),
                     EdeltaCT_VRN3=2^-(VRN3_mean - EGF1a_mean)) %>%
    mutate(TdeltaCT_VRN1=2^-(VRN1_mean -  Ta54227_mean),
                     TdeltaCT_VRN2=2^-(VRN2_mean -  Ta54227_mean),
                     TdeltaCT_VRN3=2^-(VRN3_mean -  Ta54227_mean)) ))
  
```


### PlotEGRF   HK Corrected  Values for VRN1
```{r warning=FALSE}
sample_Ct_dt %>% 
  ggplot(aes(x=Time,y=EdeltaCT_VRN1)) + 
  geom_point(aes(color=Genotype)) + 
  ggtitle('GXE Pilot Sample Date 3: VRN1, EGF HK')
```

### PlotEGRF   HK Corrected  Values for VRN2
```{r warning=FALSE}
sample_Ct_dt %>% 
  ggplot(aes(x=Time,y=EdeltaCT_VRN2)) + 
  geom_point(aes(color=Genotype)) + 
  geom_smooth(aes(color=Genotype)) +
  ggtitle('GXE Pilot Sample Date 3: VRN2, EGF HK')
```

### PlotEGRF   HK Corrected  Values for VRN3
```{r warning=FALSE}
sample_Ct_dt %>% 
  ggplot(aes(x=Time,y=EdeltaCT_VRN3)) + 
  geom_point(aes(color=Genotype)) + 
  geom_smooth(aes(color=Genotype)) +
  ggtitle('GXE Pilot Sample Date 3: VRN3, EGRF HK')
```

### Inspect IRC data
```{r warning=FALSE}
raw_dt %>% 
  filter(Task=='IRC') %>%
  group_by(plate,TargetName) %>%
  summarise(mean=mean(Ct)) %>% spread(key = TargetName,value = mean)
```


### Export Data

```{r}
write.csv(sample_Ct_dt,file='Sampledate3_bysample.csv',row.names =FALSE)
```

### Join up Dates 1 and 3

```{r}
Date1 <- fread('./Sampledate1_bysample.csv')
Date1$Date <- "Date1"
sample_Ct_dt$Date <- "Date3"

```

## Fix Genotypes
```{r}
Date1[,unique(Genotype)]
sample_Ct_dt[,unique(Genotype)]
Date1[Genotype=='OTE',Genotype:='OT'][NULL]
merged_dt <- rbindlist(list(Date1,sample_Ct_dt),use.names = TRUE)
```


### Export

this was previously **WRONG** and labelled as Dats 1 & 2

```{r}
write.csv(merged_dt,file='./Sampledates1and3Bysample.csv',row.names=FALSE)
```

### Plot Both Dates

#### VRN1

```{r warning=FALSE}
merged_dt %>%
  ggplot(aes(x=Time,y=EdeltaCT_VRN1)) +
  geom_point(aes(color=Genotype)) +
  geom_smooth(aes(color=Genotype)) +
  ggtitle('GXE Pilot Sample Date 1&3: VRN1, EGF HK') + 
  facet_wrap(~ Date)
```

#### VRN2

```{r warning=FALSE}
merged_dt %>%
  ggplot(aes(x=Time,y=EdeltaCT_VRN2)) +
  geom_point(aes(color=Genotype)) +
  geom_smooth(aes(color=Genotype)) +
  ggtitle('GXE Pilot Sample Date 1&3: VRN2, EGF HK') + 
  facet_wrap(~ Date)
```

#### VRN3

```{r warning=FALSE}
merged_dt %>%
  ggplot(aes(x=Time,y=EdeltaCT_VRN3)) +
  geom_point(aes(color=Genotype)) +
  geom_smooth(aes(color=Genotype)) +
  ggtitle('GXE Pilot Sample Date 1&3: VRN3, EGF HK') + 
  facet_wrap(~ Date)
```


